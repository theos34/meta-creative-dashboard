<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meta Creative Dashboard — HTML/CSS/JS only</title>
  <style>
    :root{color-scheme:light dark;--bg:#0b0b0c;--card:#141416;--text:#eaeaec;--muted:#9aa0a6;--accent:#4f46e5;--border:#232427}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;background:#0a0a0b;color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#0a0a0b;z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .row{display:grid;gap:12px}
    .row.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:740px){.row.kpis{grid-template-columns:repeat(4,1fr)}}
    @media(min-width:1024px){.row.kpis{grid-template-columns:repeat(6,1fr)}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .btn{appearance:none;border:none;background:var(--accent);color:white;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:default}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:10px;align-items:center}
    .grid{display:grid;gap:12px}
    .grid.creatives{grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:740px){.grid.creatives{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1024px){.grid.creatives{grid-template-columns:repeat(3,1fr)}}
    img.thumb{width:84px;height:84px;object-fit:cover;border-radius:12px;border:1px solid var(--border)}
    h1{font-size:18px;margin:0}
    h2{font-size:16px;margin:18px 0 8px}
    select, input[type="date"]{background:#0f1012;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{text-align:left;padding:10px;border-bottom:1px solid var(--border);font-size:14px}
    th{position:sticky;top:0;background:var(--card)}
    .pill{background:#101116;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .right{margin-left:auto}
    .footer{margin-top:24px;color:var(--muted);font-size:12px}
    .warning{background:#1a120f;border:1px solid #593C1F;color:#f1d6c2;padding:10px;border-radius:12px}
  </style>
</head>
<body>
  <header>
    <h1>Meta Creative Dashboard</h1>
    <div class="flex">
      <div id="status" class="pill muted">Déconnecté</div>
      <button id="loginBtn" class="btn">Se connecter à Meta</button>
      <button id="logoutBtn" class="btn" style="display:none;background:#334155">Se déconnecter</button>
    </div>
  </header>

  <div class="container">
    <div class="card warning" id="setupHelp">
      <strong>Avant de commencer :</strong> crée une app sur <em>developers.facebook.com</em>, récupère ton <strong>APP ID</strong>, remplace <code>YOUR_APP_ID</code> ci-dessous et autorise les permissions <code>ads_read</code> (et <code>business_management</code> selon ton setup). Ajoute ton domaine en <em>App Domains</em>.
    </div>

    <div class="card flex" style="flex-wrap:wrap;gap:12px;align-items:end;margin-top:12px">
      <div>
        <label class="muted" for="accountSelect">Compte pub</label><br>
        <select id="accountSelect" disabled></select>
      </div>
      <div>
        <label class="muted">Depuis</label><br>
        <input type="date" id="since">
      </div>
      <div>
        <label class="muted">Jusqu'au</label><br>
        <input type="date" id="until">
      </div>
      <div class="right flex">
        <button class="btn" id="refreshBtn" disabled>Actualiser</button>
      </div>
    </div>

    <div class="row kpis" id="kpis">
      <!-- KPI cards injected here -->
    </div>

    <h2>Créatives</h2>
    <div class="grid creatives" id="creatives"></div>

    <h2>Insights (journalier)</h2>
    <div class="card" style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Ad</th>
            <th>Dépensé</th>
            <th>Impr.</th>
            <th>Clics</th>
            <th>CTR</th>
            <th>Achats</th>
            <th>Leads</th>
            <th>CPA</th>
            <th>CPL</th>
          </tr>
        </thead>
        <tbody id="insightsBody"></tbody>
      </table>
    </div>

    <div class="footer">Prototype client-side. Pour de la prod, passe par un proxy backend (token système) pour éviter d'exposer un token utilisateur.</div>
  </div>

  <!-- Facebook JS SDK -->
  <div id="fb-root"></div>
  <script>
    // === CONFIG ===
    const FB_APP_ID = '794952376514938'; // <- remplace par ton APP ID
    const FB_API_VERSION = 'v20.0';

    // === STATE ===
    let accessToken = null;
    let selectedAccountId = null; // format act_123

    // === INIT SDK ===
    window.fbAsyncInit = function() {
      FB.init({ appId: FB_APP_ID, cookie: true, xfbml: false, version: FB_API_VERSION });
      FB.getLoginStatus(handleStatus);
    };
    (function(d, s, id){
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "https://connect.facebook.net/fr_FR/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    // === UI ELEMENTS ===
    const statusEl = document.getElementById('status');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const accountSelect = document.getElementById('accountSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const kpisEl = document.getElementById('kpis');
    const creativesEl = document.getElementById('creatives');
    const insightsBody = document.getElementById('insightsBody');
    const setupHelp = document.getElementById('setupHelp');
    const sinceInput = document.getElementById('since');
    const untilInput = document.getElementById('until');

    // Defaults: last 14 days
    const today = new Date();
    const past = new Date(Date.now() - 13*24*3600*1000);
    sinceInput.valueAsDate = past; untilInput.valueAsDate = today;

    loginBtn.onclick = () => FB.login(handleStatus, { scope: 'ads_read,business_management', return_scopes: true });
    logoutBtn.onclick = () => { FB.logout(() => location.reload()); };
    accountSelect.onchange = (e) => { selectedAccountId = e.target.value; if(selectedAccountId) loadAll(); };
    refreshBtn.onclick = () => loadAll();

    function handleStatus(response){
      if(response.status === 'connected'){
        accessToken = response.authResponse.accessToken;
        statusEl.textContent = 'Connecté';
        statusEl.classList.remove('muted');
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        setupHelp.style.display = 'none';
        fetchAdAccounts();
      } else {
        accessToken = null;
        statusEl.textContent = 'Déconnecté';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        accountSelect.disabled = true;
        refreshBtn.disabled = true;
      }
    }

    // === HELPERS ===
    async function graphGET(path, params={}){
      const qs = new URLSearchParams({ access_token: accessToken, ...params }).toString();
      const url = `https://graph.facebook.com/${FB_API_VERSION}/${path}?${qs}`;
      const res = await fetch(url);
      if(!res.ok){
        const errText = await res.text();
        throw new Error(`Graph error ${res.status}: ${errText}`);
      }
      return res.json();
    }

    async function fetchAllPages(path, params){
      let items = []; let next = null; let first = true; let url = null;
      do{
        if(first){
          const qs = new URLSearchParams({ access_token: accessToken, ...params }).toString();
          url = `https://graph.facebook.com/${FB_API_VERSION}/${path}?${qs}`;
          first = false;
        } else { url = next; }
        const res = await fetch(url);
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if(Array.isArray(data.data)) items = items.concat(data.data);
        next = data.paging && data.paging.next ? data.paging.next : null;
      } while(next);
      return items;
    }

    // === LOAD ACCOUNTS ===
    async function fetchAdAccounts(){
      setLoading(true);
      try{
        await graphGET('me');
        const accounts = await fetchAllPages('me/adaccounts', { fields: 'id,account_id,name', limit: 50 });
        accountSelect.innerHTML = '<option value="">Sélectionner un compte…</option>' +
          accounts.map(a=>`<option value="${a.id}">${a.name} (act_${a.account_id})</option>`).join('');
        accountSelect.disabled = false;
        if(accounts[0]){ accountSelect.value = accounts[0].id; selectedAccountId = accounts[0].id; loadAll(); }
      }catch(e){ alert('Erreur chargement comptes: '+e.message); }
      finally{ setLoading(false); }
    }

    function setLoading(is){ refreshBtn.disabled = is || !selectedAccountId; loginBtn.disabled = is; }

    // === LOAD EVERYTHING ===
    async function loadAll(){
      if(!selectedAccountId) return;
      setLoading(true);
      try{
        const since = sinceInput.value; const until = untilInput.value;
        const time_range = (since && until) ? JSON.stringify({ since, until }) : null;
        const [creatives, insights] = await Promise.all([
          fetchCreatives(selectedAccountId),
          fetchInsights(selectedAccountId, { time_range })
        ]);
        renderCreatives(creatives);
        renderInsights(insights);
        renderKpis(insights);
      }catch(e){ console.error(e); alert('Erreur: '+e.message); }
      finally{ setLoading(false); }
    }

    // === API: CREATIVES ===
    async function fetchCreatives(accountId){
      const fields = [
        'name','id','status','thumbnail_url','image_url','video_id','object_story_spec'
      ].join(',');
      return await fetchAllPages(`${accountId}/adcreatives`, { fields, limit: 50 });
    }

    // === API: INSIGHTS ===
    async function fetchInsights(accountId, { time_range=null }){
      const params = {
        level: 'ad', time_increment: 1,
        fields: [
          'date_start','date_stop','ad_id','adset_id','campaign_id',
          'spend','impressions','reach','clicks','unique_clicks','cpm','ctr','inline_link_clicks',
          'actions','action_values'
        ].join(',')
      };
      if(time_range) params.time_range = time_range; else params.date_preset = 'last_14d';
      return await fetchAllPages(`${accountId}/insights`, params);
    }

    // === RENDERERS ===
    function renderKpis(rows){
      const num = x => Number(x||0);
      let spend=0, clicks=0, impr=0, purchases=0, leads=0;
      rows.forEach(r=>{
        spend += num(r.spend); clicks += num(r.clicks); impr += num(r.impressions);
        const actions = toMap(r.actions);
        purchases += num(actions['offsite_conversion.purchase'] ?? actions['purchase']);
        leads += num(actions['lead'] ?? actions['offsite_conversion.lead']);
      });
      const cpa = purchases>0? spend/purchases : null;
      const cpl = leads>0? spend/leads : null;
      const ctr = impr>0? (clicks/impr)*100 : 0;
      const kpis = [
        {label:'Investi', value: `€${spend.toFixed(2)}`},
        {label:'Achats', value: purchases},
        {label:'Leads', value: leads},
        {label:'CTR', value: ctr.toFixed(2)+'%'},
        {label:'CPA', value: cpa? '€'+cpa.toFixed(2):'–'},
        {label:'CPL', value: cpl? '€'+cpl.toFixed(2):'–'},
        {label:'Clics', value: clicks},
        {label:'Impressions', value: impr}
      ];
      kpisEl.innerHTML = kpis.map(k=>`<div class="card"><div class="muted" style="font-size:12px">${k.label}</div><div style="font-size:22px;font-weight:700">${k.value}</div></div>`).join('');
    }

    function renderCreatives(items){
      creativesEl.innerHTML = items.map(c=>{
        const thumb = c.thumbnail_url || c.image_url || '';
        const title = c.name || c.id;
        const id = c.id;
        return `<div class="card flex">
          ${thumb? `<img class="thumb" src="${thumb}" alt="${title}" onerror="this.style.display='none'">` : ''}
          <div>
            <div style="font-weight:600">${escapeHtml(title)}</div>
            <div class="muted" style="font-size:12px">${c.status||''} • ${id}</div>
          </div>
        </div>`;
      }).join('');
    }

    function renderInsights(rows){
      const num = x => Number(x||0);
      insightsBody.innerHTML = rows.map(r=>{
        const actions = toMap(r.actions);
        const purchases = num(actions['offsite_conversion.purchase'] ?? actions['purchase']);
        const leads = num(actions['lead'] ?? actions['offsite_conversion.lead']);
        const spend = num(r.spend);
        const cpa = purchases>0? spend/purchases : null;
        const cpl = leads>0? spend/leads : null;
        const ctrPct = Number(r.ctr||0);
        return `<tr>
          <td>${r.date_start}</td>
          <td>${r.ad_id}</td>
          <td>€${spend.toFixed(2)}</td>
          <td>${num(r.impressions)}</td>
          <td>${num(r.clicks)}</td>
          <td>${(ctrPct).toFixed(2)}%</td>
          <td>${purchases||0}</td>
          <td>${leads||0}</td>
          <td>${cpa? '€'+cpa.toFixed(2):'–'}</td>
          <td>${cpl? '€'+cpl.toFixed(2):'–'}</td>
        </tr>`;
      }).join('');
    }

    function toMap(arr){
      const m = {}; if(Array.isArray(arr)) arr.forEach(a=>{ m[a.action_type] = Number(a.value||0); }); return m;
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;","'":"&#39;"}[c])); }
  </script>
</body>
</html>
